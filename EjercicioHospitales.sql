CREATE DATABASE HOSPITAL
GO
USE HOSPITAL
GO
CREATE TABLE ZONAS(
	ZONAID INT NOT NULL,
	NOMBRE VARCHAR(25) NOT NULL, 
)
GO
CREATE TABLE HOSPITALES(
    HOSPID INT NOT NULL,
    NOMBRE VARCHAR(25) NOT NULL,
	ZONAID INT NOT NULL)
GO
CREATE TABLE CONSULTORIOS(
    CONID INT NOT NULL,
    NOMBRE VARCHAR(25) NOT NULL,
    HOSPID INT NOT NULL)
GO
CREATE TABLE CITAS(
    CITA INT NOT NULL,
    FECHA DATE NOT NULL,
    PRESION DECIMAL NOT NULL,
    PESO DECIMAL NOT NULL,
    ESTATURA DECIMAL NOT NULL,
    OBSERVACIONES VARCHAR(100),
    CONID INT NOT NULL)
GO
--PK--
ALTER TABLE HOSPITALES ADD CONSTRAINT PK_HOSPITALES PRIMARY KEY(HOSPID)
GO
ALTER TABLE CONSULTORIOS ADD CONSTRAINT PK_CONSULTORIOS PRIMARY KEY(CONID)
GO
ALTER TABLE CITAS ADD CONSTRAINT PK_CITAS PRIMARY KEY(CITA)
GO
ALTER TABLE ZONAS ADD CONSTRAINT PK_ZONAS PRIMARY KEY(ZONAID)
GO
--FK--
ALTER TABLE CITAS ADD CONSTRAINT FK_CITAS_CONSULTORIOS
FOREIGN KEY (CONID) REFERENCES CONSULTORIOS(CONID)
GO
ALTER TABLE CONSULTORIOS ADD CONSTRAINT FK_CONSULTORIOS_HOSPITALES
FOREIGN KEY (HOSPID) REFERENCES HOSPITALES(HOSPID)
GO
ALTER TABLE HOSPITALES ADD CONSTRAINT FK_HOSPITALES_ZONAS
FOREIGN KEY (ZONAID) REFERENCES ZONAS(ZONAID)
GO
--VALORES
INSERT INTO ZONAS(ZONAID, NOMBRE)
VALUES 
	(1, 'CENTRO'),
	(2, 'NORTE'),
	(3, 'SUR')
GO
INSERT INTO HOSPITALES(HOSPID, NOMBRE, ZONAID)
VALUES 
	(10, 'Hospital Central', 1),
	(20, 'Clínica San Juan', 2),
	(30, 'Centro Médico Norte', 3),
	(40, 'Hospital Santa María', 1),
	(50, 'Clínica San Lucas', 2)
GO
INSERT INTO CONSULTORIOS(CONID, NOMBRE, HOSPID)
VALUES
	(101, 'Consultorio A', 10),
	(102, 'Consultorio B', 10),
	(103, 'Consultorio C', 20),
	(104, 'Consultorio D', 20),
	(105, 'Consultorio E', 30)
GO
INSERT INTO CITAS(CITA, FECHA, PESO, PRESION, ESTATURA, OBSERVACIONES, CONID)
VALUES
	(1001, '2020-10-05', 70, 120, 175, 'Paciente con gripe', 101),
	(1002, '2022-09-06', 65, 118, 168, 'Revisión de rutina', 102),
	(1003, '2020-05-07', 80, 130, 180, 'Dolor de espalda', 101),
	(1004, '2023-04-08', 75, 122, 170, 'Control de embarazo', 105),
	(1005, '2022-01-09', 68, 119, 172, 'Fiebre alta', 103)
GO
--FAMILIA DE VISTAS 
CREATE VIEW VW_HOSPITALES AS
SELECT HOSPID, H.NOMBRE AS HospitalNombre, 
	   Z.ZONAID, ZONANOM = Z.NOMBRE
FROM HOSPITALES H
INNER JOIN ZONAS Z ON H.ZONAID = Z.ZONAID
GO

CREATE VIEW VW_CONSULTORIOS AS
SELECT C.CONID, C.NOMBRE AS ConsultorioNombre, 
VH.HOSPID, VH.HospitalNombre AS HospitalNombre, 
VH.ZONAID, VH.ZONANOM AS ZonaNombre
FROM CONSULTORIOS C
INNER JOIN VW_HOSPITALES VH ON C.HOSPID = VH.HOSPID 
GO

CREATE VIEW VW_CITAS AS
SELECT CT.CITA, CT.FECHA, CT.PRESION, CT.PESO, CT.ESTATURA, CT.OBSERVACIONES,
VC.CONID, VC.ConsultorioNombre, VC.HOSPID, VC.HospitalNombre, VC.ZONAID, VC.ZonaNombre
FROM CITAS CT
INNER JOIN VW_CONSULTORIOS VC ON CT.CONID = VC.CONID

--CONSULTAS

--1)NOMBRE DE LA ZONA Y TOTAL DE HOSPITALES DE LA ZONA
SELECT VH.ZONANOM AS ZONA, 
COUNT(VH.HospitalNombre) AS HOSPITALES
FROM VW_HOSPITALES VH
GROUP BY VH.ZONANOM
GO

--2)NOMBRE DEL CONSULTORIO Y TOTAL DE CITAS REALIZADAS.
SELECT VC.ConsultorioNombre AS CONSULTORIO,
COUNT(VC.CITA) as #citas 
FROM VW_CITAS VC
GROUP BY VC.ConsultorioNombre
GO

--3)AÑO Y TOTAL DE CITAS REALIZADAS.
SELECT  YEAR(VC.FECHA) AS AÑO,
COUNT(VC.CITA) AS #CITAS
FROM VW_CITAS VC
GROUP BY  YEAR(VC.FECHA)
GO

--4)MES Y TOTAL DE CITAS REALIZADAS. MOSTRAR TODOS LOS MESES, SI NO TIENE CITAS, MOSTAR EN CERO. CHECAR
SELECT  MONTH(VC.FECHA) AS MES,
NUMCITAS = COUNT(VC.CITA)
FROM VW_CITAS VC
--RIGHT OUTER JOIN VW_MESES M ON M.CLAVE = DATEPART(M, VC.FECHA)
GROUP BY MONTH(VC.FECHA)

--5)NOMBRE DEL HOSPITAL Y TOTAL DE CONSULTORIOS QUE CONTIENE.
SELECT VC.HospitalNombre,
COUNT(VC.CONID) AS TotalConsultorios
FROM VW_CITAS VC
GROUP BY VC.HospitalNombre

--6)NOMBRE DEL CONSULTORIO Y PESO TOTAL DE LOS PACIENTES ATENDIDOS EN LAS CITAS 
SELECT VC.ConsultorioNombre,
 SUM(VC.PESO)
FROM VW_CITAS VC
GROUP BY VC.ConsultorioNombre

--7)NOMBRE DEL HOSPITAL Y TOTAL DE CITAS REALIZADAS POR MES DEL AÑO 2020.
SELECT VC.HospitalNombre,
COUNT(CASE WHEN DATEPART(MONTH, VC.FECHA) = 1 THEN VC.CITA ELSE NULL END) AS Enero,
    COUNT(CASE WHEN DATEPART(MONTH, VC.FECHA) = 2 THEN VC.CITA ELSE NULL END) AS Febrero,
    COUNT(CASE WHEN DATEPART(MONTH, VC.FECHA) = 3 THEN VC.CITA ELSE NULL END) AS Marzo,
    COUNT(CASE WHEN DATEPART(MONTH, VC.FECHA) = 4 THEN VC.CITA ELSE NULL END) AS Abril,
    COUNT(CASE WHEN DATEPART(MONTH, VC.FECHA) = 5 THEN VC.CITA ELSE NULL END) AS Mayo,
    COUNT(CASE WHEN DATEPART(MONTH, VC.FECHA) = 6 THEN VC.CITA ELSE NULL END) AS Junio,
    COUNT(CASE WHEN DATEPART(MONTH, VC.FECHA) = 7 THEN VC.CITA ELSE NULL END) AS Julio,
    COUNT(CASE WHEN DATEPART(MONTH, VC.FECHA) = 8 THEN VC.CITA ELSE NULL END) AS Agosto,
    COUNT(CASE WHEN DATEPART(MONTH, VC.FECHA) = 9 THEN VC.CITA ELSE NULL END) AS Septiembre,
    COUNT(CASE WHEN DATEPART(MONTH, VC.FECHA) = 10 THEN VC.CITA ELSE NULL END) AS Octubre,
    COUNT(CASE WHEN DATEPART(MONTH, VC.FECHA) = 11 THEN VC.CITA ELSE NULL END) AS Noviembre,
    COUNT(CASE WHEN DATEPART(MONTH, VC.FECHA) = 12 THEN VC.CITA ELSE NULL END) AS Diciembre
FROM VW_CITAS VC 
WHERE YEAR(VC.FECHA) = 2020
GROUP BY VC.HospitalNombre

--8)AÑO, Y TOTAL DE CITAS REALIZADAS POR DIA DE LA SEMANA.
SELECT 
    YEAR(VC.FECHA) AS AÑO,
    COUNT(CASE WHEN DATEPART(WEEKDAY, VC.FECHA) = 1 THEN VC.CITA ELSE NULL END) AS Domingo,
    COUNT(CASE WHEN DATEPART(WEEKDAY, VC.FECHA) = 2 THEN VC.CITA ELSE NULL END) AS Lunes,
    COUNT(CASE WHEN DATEPART(WEEKDAY, VC.FECHA) = 3 THEN VC.CITA ELSE NULL END) AS Martes,
    COUNT(CASE WHEN DATEPART(WEEKDAY, VC.FECHA) = 4 THEN VC.CITA ELSE NULL END) AS Miercoles,
    COUNT(CASE WHEN DATEPART(WEEKDAY, VC.FECHA) = 5 THEN VC.CITA ELSE NULL END) AS Jueves,
    COUNT(CASE WHEN DATEPART(WEEKDAY, VC.FECHA) = 6 THEN VC.CITA ELSE NULL END) AS Viernes,
    COUNT(CASE WHEN DATEPART(WEEKDAY, VC.FECHA) = 7 THEN VC.CITA ELSE NULL END) AS Sabado
FROM VW_CITAS VC
GROUP BY YEAR(VC.FECHA)

--9)AÑO Y TOTAL DE CITAS POR ZONA.
SELECT YEAR(VC.FECHA) AS AÑO,
	COUNT(CASE WHEN VC.ZONAID = 1 THEN VC.CITA ELSE NULL END) AS CENTRO,
	COUNT(CASE WHEN VC.ZONAID = 2 THEN VC.CITA ELSE NULL END) AS NORTE,
	COUNT(CASE WHEN VC.ZONAID = 3 THEN VC.CITA ELSE NULL END) AS SUR
FROM VW_CITAS VC
GROUP BY YEAR(VC.FECHA)

--10.- NOMBRE DE LA ZONA, TOTAL DE HOSPITALES QUE EXISTEN, TOTAL DE CONSULTORIOS QUE EXISTEN EN LA ZONA.
SELECT VC.ZonaNombre,
COUNT(VC.HOSPID) AS TOTALHOSPITALES,
COUNT(VC.CONID) AS TOTALCONSULTORIOS
FROM VW_CITAS VC
GROUP BY ZonaNombre






